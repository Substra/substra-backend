# Generated by Django 4.0.6 on 2022-07-28 18:28
#
# Create missing compute task output rows in the DB.
#
# This data migration will only affect Substra deployments which are upgraded from a version inferior to v17.0 (to a
# version superior or equal to v17.0). For these deployments, the compute task output rows were never created in the
# DB.

from django.db import migrations

from localrep.models.computetask import ComputeTask
from localrep.models.computetask import ComputeTaskOutput
from localrep.models.model import Model


def add_missing_compute_task_outputs(apps, schema_editor):

    for task in ComputeTask.objects.filter(outputs__isnull=True):

        # TRAIN / AGGREGATE
        if task.category in [ComputeTask.Category.TASK_TRAIN, ComputeTask.Category.TASK_AGGREGATE]:
            permission_public = True
            permission_authorized_ids = []

            models = task.models.all()
            if models:
                permission_public = models[0].permissions_process_public
                permission_authorized_ids = models[0].permissions_process_authorized_ids

            output = create_output(task, "model", permission_public, permission_authorized_ids)
            output.save()

        # COMPOSITE
        elif task.category in ComputeTask.Category.TASK_COMPOSITE:
            models = task.models.all()

            trunk_permission_public = True
            trunk_permission_authorized_ids = []
            head_permission_public = True
            head_permission_authorized_ids = []

            if models:
                head_model = [model for model in models if model.category == Model.Category.MODEL_HEAD][0]
                head_permission_public = head_model.permissions_process_public
                head_permission_authorized_ids = head_model.permissions_process_authorized_ids

                trunk_model = [model for model in models if model.category == Model.Category.MODEL_SIMPLE][0]
                trunk_permission_public = trunk_model.permissions_process_public
                trunk_permission_authorized_ids = trunk_model.permissions_process_authorized_ids

            output_trunk = create_output(task, "shared", trunk_permission_public, trunk_permission_authorized_ids)
            output_trunk.save()

            output_head = create_output(task, "local", head_permission_public, head_permission_authorized_ids)
            output_head.save()

        # PREDICT
        elif task.category in ComputeTask.Category.TASK_PREDICT:
            permission_public = True
            permission_authorized_ids = []

            models = task.models.all()
            if models:
                permission_public = models[0].permissions_process_public
                permission_authorized_ids = models[0].permissions_process_authorized_ids

            output = create_output(task, "predictions", permission_public, permission_authorized_ids)
            output.save()

        # TEST
        elif task.category in ComputeTask.Category.TASK_TEST:
            # perfs are always public
            output = create_output(task, "performance", True, [])
            output.save()


def create_output(task, identifier, permissions_public, permissions_authorized_ids):
    return ComputeTaskOutput(
        task=task,
        identifier=identifier,
        permissions_download_public=permissions_public,
        permissions_download_authorized_ids=permissions_authorized_ids,
        permissions_process_public=permissions_public,
        permissions_process_authorized_ids=permissions_authorized_ids,
    )


class Migration(migrations.Migration):

    dependencies = [
        ("localrep", "0027_remove_computetask_head_permissions_download_authorized_ids_and_more"),
    ]

    operations = [
        migrations.RunPython(add_missing_compute_task_outputs),
    ]
